# Receipt Parser GAS 仕様

## 目的
- レシート/領収書/請求書の画像/PDFをGeminiで解析し、スプレッドシートで管理・整形する
- ファイル名変更、フォルダ移動、マネーフォワード向けCSV生成を支援する

## 対象環境
- Google Apps Script（スプレッドシートに紐づくGAS）
- Google Drive（対象フォルダのファイルを読み取り/更新）
- Gemini API（レシート解析）

## 構成
- `コード.js` に主要ロジックを集約
- `appsscript.json` はGASマニフェスト

## 設定
- APIキー: スクリプトプロパティ `GEMINI_API_KEY`
  - メニュー `⚙️ APIキー設定` から登録
- モデル: スクリプトプロパティ `GEMINI_MODEL_NAME`
  - 既定は `gemini-2.5-flash-lite`
  - メニュー `⚙️ モデル切替` から変更
- 対象フォルダID: `設定` シート B2
  - シートが無い場合は自動生成

## 対応ファイル形式
- `image/jpeg`, `image/png`, `application/pdf`, `image/heic`, `image/heif`

## メニュー
スプレッドシート起動時に `🧾 レシート解析` メニューを追加
- `1. ドライブをスキャンして案を出す` → `scanToSheet`
- `2. 記入された名前を反映する` → `applyRenames`
- `指定フォルダに移動` → `moveFilesToSpecifiedFolder`
- `⚙️ APIキー設定` → `setApiKey`
- `⚙️ モデル切替` → `setModelName`
- サブメニュー `マネフォ関連`
  - `1. マネフォ用解析` → `analyzeMoneyForward`
  - `2. マネフォCSVダウンロード` → `downloadMoneyForwardCsv`

## シート仕様
### 解析結果シート（任意のシート）
自動でヘッダーを整形する。
- A: ファイルID
- B: リンク（Driveの閲覧リンク）
- C: 元ファイル名
- D: 変更案（修正可）
- E: 移動先（キーワード）
- F: ステータス
- G: 支払日
- H: 支払い方法
- I: 取引先
- J: インボイス番号
- K: 品目（概要）
- L: 金額

### `設定`
- A1:B1 = `項目名`, `設定値`
- B2 に対象フォルダIDを設定

### `置換ルール`
AIの概要を置換するためのルール。
- A: 検索キーワード
- B: 置換後の概要

### `移動先リスト`
移動先キーワードとフォルダIDの対応表。
- A: キーワード
- B: フォルダID

### `取引先一覧`
インボイス番号と取引先名の対応表。
- A: 登録番号
- B: 取引先名

### `マネフォ用`
マネーフォワードCSV出力用のシート。
ヘッダーは `MF_CSV_HEADERS` を使用して固定。

## 機能仕様
### 1) ドライブをスキャンして案を出す（`scanToSheet`）
対象フォルダ内の未処理ファイルを解析し、解析結果シートへ追加。
- 既にシートにあるファイルIDはスキップ
- `^202\\d{5}_` のファイル名はスキップ
- Geminiで JSON 抽出（支払日/支払い方法/取引先/インボイス番号/品目/金額）
- 置換ルールで品目（概要）を補正
- 解析成功時は `ステータス=未処理`、失敗時は `解析失敗`
- ファイル名の変更案（D列）は空のまま

### 2) 記入された名前を反映する（`applyRenames`）
解析結果シートの `未処理` 行のみ対象。
- D列の変更案でファイル名を更新
- 成功: `完了`
- 変更無し: `変更なし`
- 失敗: `エラー: <message>`

### 3) 指定フォルダに移動（`moveFilesToSpecifiedFolder`）
解析結果シートの `移動先` をキーワードとして移動。
- `移動先リスト` でフォルダIDを解決
- 成功: `移動済み`
- 条件不一致/未設定はスキップ

### 4) マネフォ用解析（`analyzeMoneyForward`）
対象フォルダの未処理レシートを解析し、`マネフォ用` シートへ出力。
- `CSV済` 接頭辞のファイルは対象外
- 解析対象は対応MIMEのみ
- ファイル名から `支払方法/日付/インボイス/概要` を補助的に取得
- GeminiにJSON出力を要求し、正規化して使用
- 取引先名は `取引先一覧` のインボイス番号を優先し、無ければ店舗名
- 仕訳メモにファイルURLを保存

### 5) マネフォCSVダウンロード（`downloadMoneyForwardCsv`）
`マネフォ用` シートをCSVとしてダウンロード。
- BOM付きUTF-8で生成
- `仕訳メモ` にあるファイルURLからDriveのファイルIDを抽出
- 該当ファイル名に `CSV済` を付与

## Gemini 解析仕様
### レシート抽出プロンプト出力（`callGeminiApi`）
JSON形式で以下を出力（JSONのみ・キー順固定）:
```
{
  "paymentDate": "YYYY/MM/DD",
  "paymentMethod": "現金|クレカ|PayPay|電子マネー|銀行振込",
  "vendorName": "取引先名",
  "invoiceNumber": "T1234567890123",
  "summary": "品目（概要）",
  "amount": 12345
}
```
- paymentDate は支払日（請求書は支払日が不明なら発行日）
- paymentMethod は上記の候補から選択（iD/QUICPay はクレカ扱い）
- invoiceNumber は `T` + 13桁（無い場合は空文字）
- amount は税込合計の整数（不明なら 0）

### マネフォ用プロンプト出力（`callGeminiApiForMoneyForward_`）
JSON形式で以下を出力:
```
{
  "date": "YYYY/MM/DD",
  "amount": 12345,
  "invoiceNumber": "T1234567890123",
  "vendorName": "取引先名",
  "summary": "摘要",
  "paymentMethod": "現金|クレカ|電子マネー",
  "accountTitle": "勘定科目"
}
```

## 正規化ルール
- 日付: `YYYY/MM/DD` に統一
- 金額: 数字のみ抽出して整数化
- インボイス番号: `T` + 13桁のみ抽出
- 支払方法: `現金` / `クレカ` / `PayPay` / `電子マネー` / `銀行振込` に正規化（iD/QUICPay はクレカ扱い）
- 勘定科目: 候補以外は `未入力`

## 勘定科目候補
- 旅費 / 交通費 / 車両費 / 賃借料 / 会議費 / 新聞図書費
- 運搬費 / 租税公課 / 消耗品費 / 未入力

## CSV出力
- ヘッダーは `MF_CSV_HEADERS` 固定
- `仕訳メモ` にファイルURLを出力
- `CSV済` 接頭辞で処理済み管理
