# Receipt Parser GAS 仕様

## 目的
- レシート/領収書/請求書の画像/PDFをGeminiで解析し、スプレッドシートで管理・整形する
- ファイル名変更、フォルダ移動、マネーフォワード向けCSV生成を支援する

## 対象環境
- Google Apps Script（スプレッドシートに紐づくGAS）
- Google Drive（対象フォルダのファイルを読み取り/更新）
- Gemini API（レシート解析）

## 構成
- `コード.js` に主要ロジックを集約
- `appsscript.json` はGASマニフェスト

## 設定
- APIキー: スクリプトプロパティ `GEMINI_API_KEY`
  - メニュー `設定 > APIキーの設定` から登録
- モデル: スクリプトプロパティ `GEMINI_MODEL_NAME`
  - 既定は `gemini-2.5-flash-lite`
  - メニュー `設定 > モデル切替` から変更（入力制限なし）
  - 候補例: `gemini-2.5-flash-lite`, `gemini-3-flash-preview`
- 設定シート `設定`
  - `対象フォルダURL`（URLのみ / ID単独は不可）
  - `区切り文字`（`-` / `_` / `｜`）
  - `ファイル名ルール参照`（シート名）
  - `解析上限`（1回あたりの最大解析件数）
  - `ログ出力`（ON/OFF）
  - `貸方勘定科目(クレカ)`（マネフォ用の貸方勘定科目）
  - `貸方勘定科目(それ以外)`（マネフォ用の貸方勘定科目）
  - `貸方補助科目(クレカ)`（`カード情報` / `空欄`）
  - `設定シートの初期化`は項目配置を整え、値は可能な限り維持

## 対応ファイル形式
- `image/jpeg`, `image/png`, `application/pdf`, `image/heic`, `image/heif`

## メニュー
スプレッドシート起動時に `🧾 レシート解析` メニューを追加。
- `1. レシート解析` → `scanToSheet`
- `変更案を再生成（全行）` → `regenerateAllNameCandidates`
- `解析シートをクリア` → `clearAnalysisSheet`
- `2. ファイル名反映` → `applyRenames`
- `3. フォルダ移動` → `moveFilesToSpecifiedFolder`
- `4. マネフォ用解析` → `analyzeMoneyForward`
- `5. マネフォCSVダウンロード` → `downloadMoneyForwardCsv`
- `画像プレビューを開く` → `showImageSidebar`
- `ヘルプを見る` → `showHelp`（サイドバーでGitHub Pagesを表示／表示されない場合はリンク）
- サブメニュー `⚙️ 設定`
  - `APIキーの設定` → `setApiKey`
  - `モデル切替（現在: <model>）` → `setModelName`
  - `設定シートの初期化` → `initializeConfigSheets`

## シート仕様

### 解析結果シート（解析シート）
自動でヘッダーを整形する。
- A: ファイルID
- B: リンク（Driveの閲覧リンク）
- C: 元ファイル名
- D: 変更案（修正可 / 拡張子含む）
- E: 移動先（キーワード）
- F: ステータス
- G: 支払日
- H: 支払い方法
- I: カード情報
- J: 取引先
- K: インボイス番号
- L: 品目（概要）
- M: 金額
- N: 解析メモ

### `設定`
- A1:B1 = `項目名`, `設定値`
- `対象フォルダURL` はURLのみ（IDのみは不可）

### `ファイル名ルール`
ファイル名の生成順を定義する。
- A: 項目名（支払日/支払い方法/取引先/インボイス番号/品目（概要）/金額）
- B: 順番（1,2,3...）
- C: 使用可否（チェックボックス）

### `移動先リスト`
移動先キーワードとフォルダURLの対応表。
- A: キーワード
- B: フォルダURL（URLのみ）
- 解析シートの移動先列はこのキーワードからプルダウン選択

### `勘定科目ルール`
マネフォ用の勘定科目判定ルール。
- A: 勘定科目
- B: ルール

### `取引先一覧`
インボイス番号と取引先名の対応表。
- A: 登録番号
- B: 取引先名

### `マネフォ用`
マネーフォワードCSV出力用のシート。
ヘッダーは `MF_CSV_HEADERS` を使用して固定。

### `ログ`
エラー発生時に自動作成されるログシート。
- A: 日時
- B: 機能
- C: ファイルID
- D: ファイル名
- E: 内容

## 機能仕様

### 1) レシート解析（`scanToSheet`）
対象フォルダ内の未処理ファイルを解析し、解析シートへ追加。
- 既にシートにあるファイルIDはスキップ
- `^202\\d{5}_` のファイル名はスキップ
- Geminiで JSON 抽出（支払日/支払い方法/カード情報/取引先/インボイス番号/品目/金額）
- ファイル名ルール + 区切り文字から変更案（D列）を自動生成
- 空欄は空文字として扱い、区切り文字は連続を許容
- 解析成功時は `ステータス=未処理`、失敗時は `解析失敗`
- 支払日〜金額（G〜M）が空欄の場合、セルを色付け
- 解析シート内 + 対象フォルダ内でファイル名重複時はD列を赤表示し、連番 `(1)(2)...` を付与
- ファイル名に利用できない文字は `-` に置換
- 金額は `円` を付与して提案
- 解析上限（設定シート）を超える場合は次回実行に持ち越し

### 2) ファイル名反映（`applyRenames`）
解析シートの `未処理` 行のみ対象。
- 変更案の必須欠落/重複がある場合は警告して停止
- 成功: `完了`
- 変更無し: `変更なし`
- 失敗: `エラー: <message>`
- 元ファイルの拡張子は必ず保持する

### 3) フォルダ移動（`moveFilesToSpecifiedFolder`）
解析シートの `移動先` をキーワードとして移動。
- `移動先リスト` でフォルダURLを解決（完全一致のみ）
- 一致しない場合は移動しない（`移動先なし`）
- 成功: `移動済み`
- 失敗: `移動失敗`

### 4) マネフォ用解析（`analyzeMoneyForward`）
解析シートの内容から `マネフォ用` シートへ出力。
- `CSV済` 接頭辞のファイルは対象外
- 勘定科目は `勘定科目ルール` を参照しAIで判定
- 取引先名は `取引先一覧` のインボイス番号を優先し、無ければ取引先名
- 仕訳メモにファイルURLを保存
- 支払い方法がクレカの場合、カード情報を貸方補助科目に反映

### 5) マネフォCSVダウンロード（`downloadMoneyForwardCsv`）
`マネフォ用` シートをCSVとしてダウンロード。
- BOM付きUTF-8で生成
- `仕訳メモ` にあるファイルURLからDriveのファイルIDを抽出
- 該当ファイル名に `CSV済<区切り文字>` を付与

### 6) 変更案の再生成（`regenerateAllNameCandidates`）
- 解析シートの全行を対象に、変更案（D列）を再生成する
- 既存のG〜L列とファイル名ルールのみを使い、AI APIは使わない

### 7) 解析シートのクリア（`clearAnalysisSheet`）
- 解析シートのデータ行をクリアする（ヘッダーは保持）

### 8) 画像プレビューサイドバー（`showImageSidebar`）
- 解析シートの選択行のファイルをDriveプレビューで表示
- 表示できない場合はサムネイル表示

## Gemini 解析仕様

### レシート抽出プロンプト出力（`callGeminiApi`）
JSON形式で以下を出力（JSONのみ・キー順固定）:
```
{
  "paymentDate": "YYYY/MM/DD",
  "paymentMethod": "現金|クレカ|PayPay|電子マネー|銀行振込|不明",
  "cardInfo": "カード(1234)",
  "vendorName": "取引先名",
  "invoiceNumber": "T1234567890123",
  "summary": "品目（概要）",
  "amount": 12345
}
```
- paymentDate は支払日（請求書は支払日が不明なら発行日）
- paymentMethod は上記の候補から選択（iD/QUICPay はクレカ扱い、判別不能は不明）
- cardInfo はカード下4桁を `カード(1234)` 形式で出力（不明なら `カード(不明)`）
- invoiceNumber は `T` + 13桁（登録番号表記から抽出、無い場合は空文字）
- amount は税込合計の整数（不明なら 0）

## 正規化ルール
- 日付: `YYYY/MM/DD` に統一
- 金額: 数字のみ抽出して整数化
- インボイス番号: `T` + 13桁のみ抽出
- 支払方法: `現金` / `クレカ` / `PayPay` / `電子マネー` / `銀行振込` / `不明` に正規化（iD/QUICPay はクレカ扱い）
- カード情報: クレカの場合は `カード(1234)` 形式、取れない場合は `カード(不明)`、クレカ以外は `-`
- 勘定科目: 勘定科目ルールの候補以外は `未確定勘定`

## 勘定科目候補（初期値）
- 旅費 / 交通費 / 車両費 / 賃借料 / 会議費 / 新聞図書費
- 運搬費 / 租税公課 / 消耗品費 / 未確定勘定

## CSV出力
- ヘッダーは `MF_CSV_HEADERS` 固定
- `仕訳メモ` にファイルURLを出力
- `CSV済` 接頭辞で処理済み管理
- 日付は `yyyy/MM/dd` 形式
